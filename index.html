<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rogue Community ‚Äî Key Manager</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://apis.google.com/js/api.js"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="if(window.gisLoaded) window.gisLoaded(); else window.gisLoadedPending = true;" crossorigin="anonymous"></script>
</head>
<body>
  <!-- Global banner & toast -->
  <div id="banner" aria-live="polite"></div>
  <div id="toast" aria-live="polite"></div>

  <div class="app-layout">
    <!-- Welcome/login overlay -->
    <div id="welcomeScreen" aria-modal="true" role="dialog">
      <div class="welcome-card">
        <div class="welcome-greeting" aria-hidden="true" style="display:none; opacity:0;"></div>
        <img src="./fs_logo_emoji.png" alt="Rogue Community Logo">
        <div id="loginProgress" class="login-progress" aria-hidden="true"><div class="bar"></div></div>
        <h1>Rogue Community</h1>
        <p>Key Manager ‚Äî Login</p>
        <form class="welcome-form" onsubmit="return attemptLogin(event)">
          <select id="loginPick" name="user" onchange="pickPresetUser(this.value)" style="display:none;">
            <option value="Administrator" selected>Administrator</option>
          </select>
          <div class="password-wrapper">
            <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password">
            <button type="button" id="passToggle" aria-label="Show password">üëÅÔ∏è</button>
          </div>
          <div class="welcome-actions">
            <button id="loginGo" type="submit" class="btn-primary" disabled>Continue</button>
          </div>
          <div class="login-options">
            <label><input type="checkbox" id="rememberMe"> Remember me</label>
          </div>
          <div id="loginRotator" class="welcome-rotate" aria-live="polite"></div>
          <div id="welcomeError" class="welcome-error">Incorrect username or password.</div>
        </form>
      </div>
    </div>

    <nav id="sidebar">
      <!-- Sidebar content will be rendered by JS -->
    </nav>

    <main class="main-content">
      <div class="container">
        <button id="hamburgerBtn" aria-label="Open menu">‚ò∞</button>
        <div id="mobile-overlay" onclick="toggleSidebar(false)"></div>

        <header class="header">
          <div class="logo" role="img" aria-label="Rogue Community logo"></div>
          <div class="title">
            <h1>Rogue Community ‚Äî Key Manager</h1>
            <p>A tool for staff to track and distribute keys provided by Rogue Community.</p>
          </div>
          <div class="right">
            <span id="netChip" class="chip"><span class="dot danger"></span><span id="netText">Offline</span></span>
            <span id="cloudChip" class="chip" title="Cloud status"><span class="dot danger"></span><span id="cloudLabel">Cloud</span></span>

            <div class="user-menu" id="userMenu">
              <button onclick="toggleUserDropdown()" class="btn-ghost" id="userBtn" aria-haspopup="true" aria-expanded="false">User ‚ñæ</button>
              <div id="userDropdown" class="dropdown">
                <button onclick="logout()">Logout</button>
              </div>
            </div>
          </div>
        </header>

        <div class="help">
          <details>
            <summary><strong>Quick start</strong> ‚Äî Click here to expand to show you how to import the keys.</summary>
            <ol>
              <li>Click <strong>Bulk Add</strong> ‚Üí choose product ‚Üí paste one key per line ‚Üí <strong>Add</strong>.</li>
              <li>Use the sidebar to filter by product. Search by code or user.</li>
              <li>Click <strong>Assign</strong> on a key to set Discord user, reason, and date (defaults to today).</li>
              <li>Use <strong>Export CSV</strong> for records and <strong>Backup JSON</strong>/<strong>Restore JSON</strong> to move devices.</li>
            </ol>
          </details>
        </div>

        <div id="statsBar" class="stats" aria-live="polite"></div>

        <div class="toolbar">
          <div class="group search">
            <input id="search" type="text" placeholder="Search keys, users, reason‚Ä¶ (‚åò/Ctrl + K)" style="flex:1" oninput="onSearchInput(this.value)" />
            <select id="typeFilter" onchange="onTypeFilter(this.value)" title="Filter by key type">
              <option value="All">All Types</option>
              <option value="Day">Day</option>
              <option value="Week">Week</option>
              <option value="Month">Month</option>
              <option value="Lifetime">Lifetime</option>
            </select>
            <div class="action-grid">
              <div class="left-stack">
                <button type="button" class="btn-ghost" onclick="onClearSearch()" title="Clear search">üßπ Clear</button>
                <button type="button" class="btn-ghost" id="undoBtn" onclick="onUndo()" title="Undo last action" disabled>‚Ü©Ô∏è Undo</button>
              </div>
              <div class="right-row">
                <button type="button" class="btn-ghost" onclick="onRefreshCloud()" title="Force re-fetch from cloud">üîÑ Refresh</button>
                <button type="button" class="btn-primary" onclick="onBulkAdd()" title="Add many keys quickly">üì• Bulk Add</button>
              </div>
            </div>
          </div>
          <div class="group menu-wrap">
            <button type="button" class="btn-ghost" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">üåô / ‚òÄÔ∏è</button>
            <button type="button" class="btn-primary" onclick="toggleManageMenu()" aria-haspopup="true" aria-expanded="false">Manage ‚ñæ</button>
            <div id="manageMenu" class="dropdown" role="menu" aria-label="Manage actions">
              <button type="button" class="item" onclick="onNewSingle()">‚ûï New Single</button>
              <button type="button" class="item" onclick="onExportCSV()">‚¨áÔ∏è Export CSV</button>
              <button type="button" class="item" onclick="onBackupJSON()">üíæ Backup JSON</button>
              <label for="restoreJSON" class="item">‚§¥Ô∏è Import JSON to Cloud
                <input id="restoreJSON" type="file" accept="application/json" onchange="onImportJSON(this.files && this.files[0])">
              </label>
            </div>
          </div>
        </div>

        <div id="tableWrap"></div>
      </div>
    </main>
  </div>

  <!-- Assign Modal -->
  <dialog id="assignModal">
    <form method="dialog">
      <div class="modal-header">
        <strong>Assign key</strong>
        <button type="button" onclick="closeDialog('assignModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="field"><label>Key</label><input id="m_code" type="text" readonly></div>
        <div class="field"><label>Product</label><input id="m_product" type="text" readonly></div>
        <div class="field"><label>Discord user</label><input id="m_user" type="text" placeholder="@username or ID" required></div>
        <div class="field"><label>Reason</label><input id="m_reason" type="text" placeholder="e.g. Promo, replacement, test" required></div>
        <div class="field"><label>Date</label><input id="m_date" type="date" required></div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeDialog('assignModal')">Cancel</button>
        <button type="button" class="btn-primary" onclick="saveAssign()">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Bulk Add Modal -->
  <dialog id="bulkModal">
    <form method="dialog">
      <div class="modal-header">
        <strong>Bulk add keys</strong>
        <button type="button" onclick="closeDialog('bulkModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Product</label>
          <select id="bulkProduct"></select>
        </div>
        <div class="field">
          <label>Type</label>
          <select id="bulkType"><option value="Day">Day</option><option value="Week">Week</option><option value="Month">Month</option><option value="Lifetime">Lifetime</option></select>
        </div>
        <div class="field">
          <label>Paste keys (one per line)</label>
          <textarea id="bulkText" placeholder="KEY-ABC-123&#10;KEY-DEF-456&#10;‚Ä¶"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeDialog('bulkModal')">Cancel</button>
        <button type="button" class="btn-primary" onclick="saveBulkAdd()">Add</button>
      </div>
    </form>
  </dialog>

  <!-- Single Add Modal -->
  <dialog id="singleModal">
    <form method="dialog">
      <div class="modal-header">
        <strong>New key</strong>
        <button type="button" onclick="closeDialog('singleModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="field"><label>Product</label>
          <select id="s_product"></select></div>
        <div class="field"><label>Type</label>
          <select id="s_type"><option>Day</option><option>Week</option><option>Month</option><option>Lifetime</option></select>
        </div>
        <div class="field"><label>Key code</label>
          <input id="s_code" type="text" placeholder="Paste the actual code" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeDialog('singleModal')">Cancel</button>
        <button type="button" class="btn-primary" onclick="saveSingleAdd()">Add</button>
      </div>
    </form>
  </dialog>

  <!-- Product Manager Modal -->
  <dialog id="productModal">
    <form method="dialog">
      <div class="modal-header">
        <strong>Manage Products</strong>
        <button type="button" onclick="closeDialog('productModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="productList" style="display:flex; flex-direction:column; gap:8px; margin-bottom:16px;"></div>
        <div class="field" style="border-top:1px solid rgba(255,255,255,.1); padding-top:16px;">
          <label>Add New Product</label>
          <input id="newProductName" type="text" placeholder="Product Name">
          <label>Badge Color</label>
          <input id="newProductColor" type="color" value="#F47174" style="padding:2px; height:32px;">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeDialog('productModal')">Close</button>
        <button type="button" class="btn-primary" onclick="onAddProduct()">Add Product</button>
      </div>
    </form>
  </dialog>

  <!-- Edit Product Modal -->
  <dialog id="editProductModal">
    <form method="dialog">
      <div class="modal-header">
        <strong>Edit Product</strong>
        <button type="button" onclick="closeDialog('editProductModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <input id="editProductOriginalName" type="hidden">
        <div class="field"><label>Product Name</label>
          <input id="editProductName" type="text" placeholder="Product Name"></div>
        <div class="field"><label>Badge Color</label>
          <input id="editProductColor" type="color" style="padding:2px; height:32px;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeDialog('editProductModal')">Cancel</button>
        <button type="button" class="btn-primary" onclick="onSaveProductEdit()">Save Changes</button>
      </div>
    </form>
  </dialog>

  <!-- History Modal -->
  <dialog id="historyModal">
    <form method="dialog">
      <div class="modal-header">
        <strong>Key History</strong>
        <button type="button" onclick="closeDialog('historyModal')">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="historyKeyInfo" style="font-size:13px; color:var(--muted); margin-bottom:16px;"></div>
        <div id="historyList"></div>
      </div>
      <div class="modal-footer"><button type="button" onclick="closeDialog('historyModal')">Close</button></div>
    </form>
  </dialog>

  <button id="backTop" onclick="scrollTopSmooth()" aria-label="Scroll to top of page" style="position:fixed;right:16px;bottom:16px;display:none;">‚Üë Top</button>
  <script src="app.js"></script>
  <div class="footer-note">Rogue Community Key Manager ¬∑ v1.2 ¬∑ Updated 23 Oct 2025</div>
</body>
</html>
