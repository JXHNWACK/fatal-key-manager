<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fatal Services — Key Manager</title>
  <style>
    :root{
      --bg:#12111F;
      --panel:#1A1930;
      --panel-2:#0F0F1A;
      --text:#E7F6F7;
      --muted:#A7B8BB;
      --accent:#69CFDA;
      --accent-2:#41A8B5;
      --danger:#EF476F;
      --ok:#06D6A0;
      --warn:#FFD166;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    *, *::before, *::after{ box-sizing: border-box; }
    html, body{ max-width:100%; overflow-x:hidden; }
    :root.light{
      --bg:#F6F7FB; --panel:#FFFFFF; --panel-2:#F2F4F7; --text:#111319; --muted:#5A6570;
      --accent:#178C97; --accent-2:#0E6F79; --danger:#C43C5C; --ok:#0E9F79; --warn:#E4A329;
      --shadow: 0 10px 30px rgba(0,0,0,.10);
    }

    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 50% -100px, rgba(105,207,218,.15), transparent 60%), var(--bg);
      color:var(--text);
    }
    .container{max-width:1100px; margin:24px auto; padding:0 16px}
    .header{display:flex; align-items:center; gap:16px; padding:16px; background:linear-gradient(180deg, rgba(105,207,218,.08), rgba(105,207,218,.02)); border:1px solid rgba(105,207,218,.25); border-radius:var(--radius); box-shadow:var(--shadow)}
    .logo{
      width:78px; height:78px; border-radius:50%; background:#0c0c16 url('./fs_logo_emoji.png') center/cover no-repeat;
      box-shadow:0 0 30px rgba(105,207,218,.55) inset, 0 0 22px rgba(105,207,218,.35);
      animation: pulse-glow 2.5s infinite; position: relative; z-index: 1;
    }

    .toolbar .group.search{ align-items:center; }
    .action-grid{ display:flex; gap:8px; align-items:center; width:auto; }
    .action-grid .left-stack{ display:flex; flex-direction:row; gap:8px; }
    .action-grid .right-row{ display:flex; flex-direction:row; gap:8px; margin-left:8px; }
    .action-grid .left-stack button,
    .action-grid .right-row button{ width:auto; }

    @media (max-width: 680px){
      .action-grid{ width:100%; justify-content:space-between; }
      .action-grid .left-stack{ flex-direction:column; gap:8px; flex:1 1 48%; }
      .action-grid .left-stack button{ width:100%; }
      .action-grid .right-row{ flex:1 1 48%; justify-content:flex-end; }
      .toolbar .group.search input{ margin-bottom:6px; }
    }

    @keyframes pulse-glow {
      0% { box-shadow: 0 0 0 rgba(105,207,218, 0.7), 0 0 22px rgba(105,207,218,.35) inset; }
      70%{ box-shadow: 0 0 40px rgba(105,207,218, 0), 0 0 22px rgba(105,207,218,.35) inset; }
      100%{ box-shadow: 0 0 0 rgba(105,207,218, 0.7), 0 0 22px rgba(105,207,218,.35) inset; }
    }

    .title h1{margin:0; font-size:22px; letter-spacing:.5px}
    .title p{margin:4px 0 0; color:var(--muted); font-size:13px}

    .toolbar{display:flex; flex-wrap:wrap; gap:8px; margin:16px 0}
    .toolbar .group{display:flex; gap:8px; background:var(--panel); padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.06)}
    .toolbar .group.stack{ flex-direction: column; align-items: stretch; gap:6px; }
    .toolbar .group.stack button,
    .toolbar .group.stack label.btn-ghost,
    .toolbar .group.stack .btn-primary{ font-size:12px; padding:8px 10px; line-height:1.1; }

    button, select, input[type="date"], input[type="text"]{
      background:var(--panel-2); color:var(--text); border:1px solid rgba(255,255,255,.1); padding:10px 12px; border-radius:10px; cursor:pointer; font-size:14px
    }
    button:hover{border-color:rgba(105,207,218,.6)}
    .btn-primary{background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:#071216; font-weight:600; border:none}
    .btn-ghost{background:transparent; border:1px dashed rgba(255,255,255,.18)}
    .btn-ghost[disabled]{opacity:.45; cursor:not-allowed;}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.04)}
    .dot{width:8px; height:8px; border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.danger{background:var(--danger)}

    .tabs{display:flex; gap:8px; margin:10px 0 14px}
    .tab{padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03); cursor:pointer}
    .tab.active{background:linear-gradient(180deg, rgba(105,207,218,.22), rgba(105,207,218,.08)); border-color:rgba(105,207,218,.6)}

    table{width:100%; border-collapse:separate; border-spacing:0 6px}
    thead th{font-size:12px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:.6px; text-align:left; padding:0 12px}
    tbody tr{background:var(--panel); box-shadow:var(--shadow)}
    td{padding:8px 8px; border-top:1px solid rgba(255,255,255,.06); border-bottom:1px solid rgba(255,255,255,.06)}
    thead th.sortable{ cursor:pointer; user-select:none; }
    thead th.sortable:hover{ color: var(--text); filter: brightness(1.05); }
    thead th .caret{ opacity:.8; margin-left:6px; font-size:11px; }
    td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
    td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}

    .actions{display:flex; gap:6px; flex-wrap:wrap}
    .empty{padding:24px; text-align:center; color:var(--muted); border:1px dashed rgba(255,255,255,.15); border-radius:12px; background:rgba(255,255,255,.02)}

    dialog{border:none; border-radius:16px; padding:0; background:var(--panel); color:var(--text); box-shadow:var(--shadow); width:min(520px, 92vw)}
    .modal-header{padding:14px 18px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; justify-content:space-between; align-items:center}
    .modal-body{padding:18px}
    .modal-footer{padding:14px 18px; border-top:1px solid rgba(255,255,255,.08); display:flex; justify-content:flex-end; gap:10px}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:12px}
    .field label{font-size:12px; color:var(--muted)}
    textarea{width:100%; min-height:120px; resize:vertical; background:var(--panel-2); color:var(--text); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:10px}

    .search{flex:1}
    .right{margin-left:auto}
    .help{margin-top:12px; font-size:13px; color:var(--muted)}
    details{background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px}
    details[open]{background:rgba(255,255,255,.05)}
    summary{cursor:pointer}
    code{background:rgba(0,0,0,.35); padding:2px 6px; border-radius:6px}

    #banner{position:fixed;top:-80px;left:50%;transform:translateX(-50%);z-index:10000;transition:top .35s ease,opacity .35s ease;opacity:0}
    #banner.show{top:10px;opacity:1}
    #banner .msg{position:relative;display:flex;align-items:center;gap:8px;background:linear-gradient(180deg,rgba(239,71,111,.95),rgba(239,71,111,.88));color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 24px rgba(239,71,111,.35);border:1px solid rgba(255,255,255,.12);font-size:14px;letter-spacing:.2px}
    #banner .msg button.close{appearance:none;-webkit-appearance:none;position:relative;margin-left:6px;border:none;background:rgba(0,0,0,.15);color:#fff;border-radius:8px;cursor:pointer;font-size:14px;line-height:1;padding:6px 8px}
    #banner .msg button.close:hover{background:rgba(0,0,0,.25)}

    #toast{ position: fixed; inset: 0; display: none; z-index: 10000; pointer-events: none; }
    #toast .msg{
      position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) scale(0.92);
      background: linear-gradient(180deg, rgba(6,214,160,.95), rgba(6,214,160,.88));
      color: #071216; padding: 12px 16px; border-radius: 14px; box-shadow: 0 14px 30px rgba(6,214,160,.30);
      border: 1px solid rgba(0,0,0,.10); font-weight: 800; font-size: 14px; letter-spacing: .2px;
      animation: toast-pop 1.8s ease forwards;
    }
    @keyframes toast-pop{ 0%{opacity:0;transform:translate(-50%,-50%) scale(.92);}10%{opacity:1;transform:translate(-50%,-50%) scale(1);}80%{opacity:1;transform:translate(-50%,-50%) scale(1.02);}100%{opacity:0;transform:translate(-50%,-50%) scale(.98);} }

    .tabs{position:relative}
    .tab-underline{position:absolute;bottom:-4px;height:3px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0;transform:translateX(0);transition:transform .25s ease,width .25s ease,opacity .25s ease;opacity:.95;pointer-events:none;z-index:2}

    /* Welcome/login overlay */
    #welcomeScreen{
      position:fixed; inset:0; background:var(--bg);
      display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    .welcome-card{
      width:min(520px, 92vw); background:var(--panel);
      border:1px solid rgba(255,255,255,.06); border-radius:20px; box-shadow:var(--shadow);
      padding:28px; text-align:center;
    }
    .welcome-card img{ width:84px; height:84px; border-radius:12px; margin-bottom:12px; box-shadow:0 0 22px rgba(105,207,218,.35); }
    .welcome-card h1{ margin:0; font-size:22px; color:var(--accent); letter-spacing:.4px; }
    .welcome-card p{ margin:6px 0 16px; color:var(--muted); }
    .welcome-form{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .welcome-form input, .welcome-form select{
      background:var(--panel-2); color:var(--text); border:1px solid rgba(255,255,255,.1);
      border-radius:10px; padding:10px 12px; font-size:14px;
    }
    .welcome-actions{ display:flex; gap:8px; justify-content:center; margin-top:10px; }
    .welcome-error{ display:none; margin-top:8px; color:var(--danger); font-size:13px; }

    .welcome-greeting{
      font-size: 28px; font-weight: 800; letter-spacing: 4px; color: var(--text);
      opacity: 0; margin: 0 0 10px 0; text-transform: uppercase; text-align: center;
      text-shadow: 0 0 16px rgba(105,207,218,.25); animation: greet-glow 2.8s ease-in-out infinite;
      transition: opacity .8s ease;
    }
    @keyframes greet-glow{ 0%,100%{ text-shadow: 0 0 12px rgba(105,207,218,.20); opacity:.95; } 50%{ text-shadow: 0 0 20px rgba(105,207,218,.45); opacity:1; } }

    .welcome-card img.login-pulse{ animation: login-glow 3.6s ease-in-out 1; }
    @keyframes login-glow{
      0%{ filter:none; box-shadow:0 0 26px rgba(105,207,218,.45); }
      25%{ filter:brightness(1.10) saturate(1.08); box-shadow:0 0 56px rgba(105,207,218,.85); }
      50%{ filter:brightness(1.18) saturate(1.12); box-shadow:0 0 72px rgba(105,207,218,.95); }
      75%{ filter:brightness(1.10) saturate(1.08); box-shadow:0 0 56px rgba(105,207,218,.85); }
      100%{ filter:none; box-shadow:0 0 26px rgba(105,207,218,.45); }
    }
    .welcome-card .login-progress{ display:none; height:6px; margin:6px 0 2px; border-radius:999px; overflow:hidden; background: var(--panel-2); border:1px solid rgba(255,255,255,.08); }
    .welcome-card .login-progress .bar{ height:100%; width:0; background: linear-gradient(90deg, var(--accent), var(--accent-2)); animation: progress-run 3.6s ease-in-out forwards; }
    @keyframes progress-run{ from{ width:0% } to{ width:100% } }

    .welcome-card.shake{ animation: shake .4s ease; }
    @keyframes shake{ 0%,100%{ transform:translateX(0); } 20%{ transform:translateX(-6px); } 40%{ transform:translateX(6px); } 60%{ transform:translateX(-4px); } 80%{ transform:translateX(4px); } }

    .user-menu{position:relative; display:none; margin-left:12px;}
    .user-menu .dropdown{
      display:none; position:absolute; right:0; top:110%;
      background:var(--panel); border:1px solid rgba(255,255,255,.1);
      border-radius:10px; box-shadow:var(--shadow); min-width:140px; z-index:10000;
    }
    .user-menu .dropdown button{
      width:100%; text-align:left; background:transparent; border:none; color:var(--text); padding:10px; cursor:pointer;
    }
    .user-menu .dropdown button:hover{background:rgba(255,255,255,.08);}

    .toolbar .menu-wrap{ position:relative; }
    .toolbar .dropdown{
      display:none; position:absolute; right:0; top:110%;
      background:var(--panel); border:1px solid rgba(255,255,255,.1);
      border-radius:10px; box-shadow:var(--shadow); min-width:200px; z-index:10000; padding:6px;
    }
    .toolbar .dropdown .item{ display:block; width:100%; text-align:left; background:transparent; border:none; color:var(--text); padding:10px; cursor:pointer; border-radius:8px; }
    .toolbar .dropdown .item:hover{ background:rgba(255,255,255,.08); }
    .toolbar .dropdown .divider{ height:1px; background:rgba(255,255,255,.08); margin:6px 0; }
    .toolbar label.item{ display:flex; align-items:center; gap:8px; cursor:pointer; }
    .toolbar label.item input{ display:none; }

    .header{ position:relative; overflow:hidden; }
    .header::before{
      content:""; position:absolute; inset:-30%;
      background:
        radial-gradient(600px 320px at 12% 40%, rgba(105,207,218,.22), transparent 60%),
        radial-gradient(420px 260px at 88% -10%, rgba(105,207,218,.12), transparent 65%);
      filter: blur(18px); animation: header-pulse 6s ease-in-out infinite; z-index:0;
    }
    .header > *{ position:relative; z-index:1; }
    @keyframes header-pulse{ 0%,100%{ opacity:.55; transform:scale(1); } 50%{ opacity:.9; transform:scale(1.03); } }

    button, .tab{ transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease; }
    button:hover{ transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,.28); }
    .btn-primary:hover{ transform: translateY(-1px); box-shadow: 0 10px 26px rgba(105,207,218,.30); filter: brightness(1.02); }
    .tab:hover{ transform: translateY(-1px); border-color: rgba(105,207,218,.6); background: linear-gradient(180deg, rgba(105,207,218,.18), rgba(105,207,218,.06)); }

    tbody tr{ transition: background .15s ease, transform .15s ease; }
    tbody tr:hover{ background: rgba(105,207,218,.06); transform: translateY(-1px); }

    @keyframes pulse-danger { 0%{ box-shadow: 0 0 0 0 rgba(239,71,111,.8);} 50%{ box-shadow: 0 0 24px 6px rgba(239,71,111,.45);} 100%{ box-shadow: 0 0 0 0 rgba(239,71,111,.8);} }
    .chip .dot.danger{ animation: pulse-danger 1.5s ease-in-out infinite; }

    @keyframes pulse-warn { 0%{ box-shadow: 0 0 0 0 rgba(255,209,102,.75);} 50%{ box-shadow: 0 0 22px 6px rgba(255,209,102,.40);} 100%{ box-shadow: 0 0 0 0 rgba(255,209,102,.75);} }
    .chip .dot.warn{ animation: pulse-warn 1.6s ease-in-out infinite; }

    .key-cell{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight: 600; font-size: 14px; line-height: 1.05; white-space: nowrap; }

    .badge{ display:inline-block; padding:2px 8px; font-size:13px; font-weight:600; border-radius:8px; text-transform:capitalize; }
    .badge.Day{ background:rgba(105,207,218,.18); color:var(--accent); }
    .badge.Week{ background:rgba(255,209,102,.18); color:var(--warn); }
    .badge.Month{ background:rgba(239,71,111,.18); color:var(--danger); }
    .badge.Lifetime{ background:rgba(14,159,121,.18); color:var(--ok); }

    /* --- Stats bar & highlights & product badges --- */
    .stats{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; margin:12px 0 14px; }
    .stat-card{ background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; box-shadow:var(--shadow); }
    .stat-title{ font-size:12px; color:var(--muted); margin:0 0 6px; text-transform:uppercase; letter-spacing:.6px; }
    .stat-value{ font-size:20px; font-weight:800; margin:0; }
    .stat-sub{ font-size:12px; color:var(--muted); margin-top:4px; }

    mark.hl{ background: rgba(255,209,102,.35); color: inherit; padding: 0 2px; border-radius: 4px; }

    .pbadge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; letter-spacing:.3px; }
    .pbadge.p-shadow{ background:rgba(105,207,218,.18); color:var(--accent); border:1px solid rgba(105,207,218,.35); }
    .pbadge.p-black{ background:rgba(255,255,255,.06); color:#E7F6F7; border:1px solid rgba(255,255,255,.18); }
    .pbadge.p-nebula{ background:rgba(121,86,255,.18); color:#A99CFF; border:1px solid rgba(121,86,255,.35); }
    .pbadge.p-fatality{ background:rgba(239,71,111,.18); color:#EF476F; border:1px solid rgba(239,71,111,.35); }

    .footer-note{ margin: 22px auto 10px; text-align:center; color:var(--muted); font-size:12px; opacity:.9; }

    @keyframes pulse-ok { 0%{ box-shadow: 0 0 0 0 rgba(6,214,160,.70);} 50%{ box-shadow: 0 0 20px 6px rgba(6,214,160,.35);} 100%{ box-shadow: 0 0 0 0 rgba(6,214,160,.70);} }
    .chip .dot.ok{ animation: pulse-ok 2s ease-in-out infinite; }

    dialog::backdrop{ background: rgba(0,0,0,.6); backdrop-filter: blur(6px); }
    .toolbar{ position: sticky; top: 12px; z-index: 50; backdrop-filter: blur(6px); background: rgba(26,25,48,.75); border: 1px solid rgba(255,255,255,.06); }
    :focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; }
    #bulkText{ min-height: 100px; }
    #bulkModal textarea#bulkText{ width: 100%; box-sizing: border-box; }

    @media (max-width: 540px){
      html, body{ max-width:100%; overflow-x:hidden; }
      body{ font-size:14px; }
      .title h1{ font-size:16px; }
      .title p{ font-size:11px; }
      .chip{ font-size:11px; padding:4px 8px; }
      .tab{ padding:6px 10px; font-size:12px; }
      .toolbar .group.search input{ font-size:14px; padding:8px 10px; }
      .toolbar .group.search button,
      .toolbar .group button{ font-size:13px; padding:8px 10px; }
      tbody td:first-child{ font-size:13px; }
      tbody td::before{ font-size:11px; }
      .actions button{ font-size:12px; padding:7px 8px; }
      dialog{ font-size:14px; }
      .welcome-card h1{ font-size:18px; }
      .welcome-card p{ font-size:12px; }
      .welcome-form input, .welcome-form select{ font-size:14px; padding:8px 10px; }
      .welcome-actions button{ font-size:14px; padding:8px 12px; }

      .container{ max-width:100%; padding:0 10px; }
      .header{ flex-direction: row; align-items: center; flex-wrap: nowrap; gap: 6px; width: 100%; box-sizing: border-box; }
      .title{ order: 2; flex: 1 1 auto; max-width: 100%; min-width: 0; display: block; margin: 0; }
      .title h1{ margin: 0 0 4px 0; font-size: 14px; letter-spacing: .4px; line-height: 1.1; white-space: normal; overflow: visible; text-overflow: initial; }
      .title p{ margin: 0; font-size: 10px; color: var(--muted); line-height: 1.15; white-space: normal; overflow: visible; text-overflow: initial; }
      .logo{ order: 1; flex: 0 0 56px; width: 56px; height: 56px; aspect-ratio: 1/1; border-radius: 50%; margin-right: 8px; margin-left: 0; }
      .right{ order: 3; width: 100%; display: flex; flex-wrap: wrap; gap: 6px; }

      .toolbar{ position: static; top: auto; backdrop-filter: none; background: transparent; border: none; }
      .toolbar .group{ width:100%; }
      .toolbar .group.search{ flex-direction:column; gap:6px; }
      .toolbar .group.search input{ width:100%; }
      .toolbar .group.search button{ width:100%; }

      thead{ display:none; }
      table{ border-spacing:0; }
      table, tbody, tr, td{ display:block; width:100%; }
      tbody tr{
        background:var(--panel); border:1px solid rgba(255,255,255,.06);
        border-radius:14px; padding:10px 12px; margin:10px 0; box-shadow: var(--shadow);
      }
      tbody td{ border:0; padding:6px 0; display:flex; justify-content:space-between; align-items:center; gap:10px; word-break:break-word; }
      tbody td:first-child{
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:700; font-size:14px;
        padding:4px 0 6px 0; border:0; white-space:normal;
      }
      tbody td:nth-child(2)::before{ content:"Product"; color:var(--muted); font-size:12px; }
      tbody td:nth-child(3)::before{ content:"Type";    color:var(--muted); font-size:12px; }
      tbody td:nth-child(4)::before{ content:"Status";  color:var(--muted); font-size:12px; }
      tbody td:nth-child(5)::before{ content:"User";    color:var(--muted); font-size:12px; }
      tbody td:nth-child(6)::before{ content:"Reason";  color:var(--muted); font-size:12px; }
      tbody td:nth-child(7)::before{ content:"Date";    color:var(--muted); font-size:12px; }

      tbody td:last-child{ padding-top:10px; gap:8px; flex-wrap:wrap; }
      .actions{ gap:8px; }
      .actions button{ flex:1 1 48%; padding:8px 10px; font-size:13px; }
      .actions .btn-primary{ flex:1 1 100%; }

      dialog{ width:94vw; }
      #bulkModal textarea#bulkText{ min-height:90px; }

      .user-menu{ display:block !important; }
      .user-menu #userBtn{ display:none; }
      .user-menu .dropdown{ display:block !important; position: static; background: transparent; border: none; box-shadow: none; padding: 0; margin: 0; }
      .user-menu .dropdown button{ background: var(--panel-2); border: 1px solid rgba(255,255,255,.12); border-radius: 999px; padding: 6px 10px; font-size: 12px; }

      /* Compact stats bar on mobile */
      .stats{ grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; margin:10px 0 12px; }
      .stat-card{ padding:8px 10px; border-radius:10px; }
      .stat-title{ font-size:10px; margin-bottom:4px; }
      .stat-value{ font-size:14px; }
      .stat-sub{ font-size:10px; }

      /* Tabs: compact & 2-per-row on mobile */
      .tabs{ display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; margin: 8px 0 10px; }
      .tab{ width: 100%; text-align: center; padding: 8px 10px; font-size: 12px; }
      .tabs .tab-underline{ display: none; }
    }
  </style>
</head>
<body>
  <!-- Global banner & toast -->
  <div id="banner" aria-live="polite"></div>
  <div id="toast" aria-live="polite"></div>

  <!-- Welcome/login overlay -->
  <div id="welcomeScreen" aria-modal="true" role="dialog">
    <div class="welcome-card">
      <div class="welcome-greeting" aria-hidden="true" style="display:none; opacity:0;"></div>
      <img src="./fs_logo_emoji.png" alt="Fatal Services Logo">
      <div id="loginProgress" class="login-progress" aria-hidden="true"><div class="bar"></div></div>
      <h1>Fatal Services</h1>
      <p>Key Manager — Login</p>
      <form class="welcome-form" onsubmit="return attemptLogin(event)">
        <select id="loginPick" onchange="pickPresetUser(this.value)">
          <option value="">Choose a user…</option>
          <option value="UncleJoey">UncleJoey</option>
          <option value="UncleG">UncleG</option>
          <option value="UncleTrash">UncleTrash</option>
          <option value="JXHNWACK">JXHNWACK</option>
        </select>
        <input id="loginPass" type="password" placeholder="Password" autocomplete="current-password">
        <div class="welcome-actions">
          <button id="loginGo" type="submit" class="btn-primary" disabled>Continue</button>
        </div>
        <div id="loginRotator" class="welcome-rotate" aria-live="polite"></div>
        <div id="welcomeError" class="welcome-error">Incorrect username or password.</div>
      </form>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="logo" aria-label="Fatal Services logo"></div>
      <div class="title">
        <h1>Fatal Services — Key Manager</h1>
        <p>A tool for staff to track and distribute keys provided by Fatal Services.</p>
      </div>
      <div class="right">
        <span id="netChip" class="chip"><span class="dot danger"></span><span id="netText">Offline</span></span>
        <span id="cloudChip" class="chip" title="Cloud status"><span class="dot danger"></span><span id="cloudLabel">Cloud</span></span>

        <div class="user-menu" id="userMenu">
          <button onclick="toggleUserDropdown()" class="btn-ghost" id="userBtn">User ▾</button>
          <div id="userDropdown" class="dropdown">
            <button onclick="logout()">Logout</button>
          </div>
        </div>
      </div>
    </div>

    <div class="help">
      <details>
        <summary><strong>Quick start</strong> — Click here to expand to show you how to import the keys.</summary>
        <ol>
          <li>Click <strong>Bulk Add</strong> → choose product → paste one key per line → <strong>Add</strong>.</li>
          <li>Use the tabs to filter by product. Search by code or user.</li>
          <li>Click <strong>Assign</strong> on a key to set Discord user, reason, and date (defaults to today).</li>
          <li>Use <strong>Export CSV</strong> for records and <strong>Backup JSON</strong>/<strong>Restore JSON</strong> to move devices.</li>
        </ol>
      </details>
    </div>

    <div class="tabs" id="tabs"></div>
    <div id="statsBar" class="stats" aria-live="polite"></div>

    <div class="toolbar">
      <div class="group search">
        <input id="search" type="text" placeholder="Search keys, users, reason… (⌘/Ctrl + K)" style="flex:1" oninput="onSearchInput(this.value)" />
        <select id="typeFilter" onchange="onTypeFilter(this.value)" title="Filter by key type">
          <option value="All">All Types</option>
          <option value="Day">Day</option>
          <option value="Week">Week</option>
          <option value="Month">Month</option>
          <option value="Lifetime">Lifetime</option>
        </select>
        <div class="action-grid">
          <div class="left-stack">
            <button type="button" class="btn-ghost" onclick="onClearSearch()" title="Clear search">🧹 Clear</button>
            <button type="button" class="btn-ghost" id="undoBtn" onclick="onUndo()" title="Undo last action" disabled>↩️ Undo</button>
          </div>
          <div class="right-row">
            <button type="button" class="btn-ghost" onclick="onRefreshCloud()" title="Force re-fetch from cloud">🔄 Refresh</button>
            <button type="button" class="btn-primary" onclick="onBulkAdd()" title="Add many keys quickly">📥 Bulk Add</button>
          </div>
        </div>
      </div>
      <div class="group menu-wrap">
        <button type="button" class="btn-ghost" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">🌙 / ☀️</button>
        <button type="button" class="btn-primary" onclick="toggleManageMenu()" aria-haspopup="true" aria-expanded="false">Manage ▾</button>
        <div id="manageMenu" class="dropdown" role="menu" aria-label="Manage actions">
          <button type="button" class="item" onclick="onNewSingle()">➕ New Single</button>
          <div class="divider"></div>
          <button type="button" class="item" onclick="onExportCSV()">⬇️ Export CSV</button>
          <button type="button" class="item" onclick="onBackupJSON()">💾 Backup JSON</button>
          <label for="restoreJSON" class="item">⤴️ Import JSON to Cloud
            <input id="restoreJSON" type="file" accept="application/json" onchange="onImportJSON(this.files && this.files[0])">
          </label>
        </div>
      </div>
    </div>

    <div id="tableWrap"></div>
  </div>

  <!-- Assign Modal -->
  <dialog id="assignModal">
    <form method="dialog">
      <div class="modal-header">
        <strong>Assign key</strong>
        <button type="button" onclick="closeDialog('assignModal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="field"><label>Key</label><input id="m_code" type="text" readonly></div>
        <div class="field"><label>Product</label><input id="m_product" type="text" readonly></div>
        <div class="field"><label>Discord user</label><input id="m_user" type="text" placeholder="@username or ID" required></div>
        <div class="field"><label>Reason</label><input id="m_reason" type="text" placeholder="e.g. Promo, replacement, test" required></div>
        <div class="field"><label>Date</label><input id="m_date" type="date" required></div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeDialog('assignModal')">Cancel</button>
        <button type="button" class="btn-primary" onclick="saveAssign()">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Bulk Add Modal -->
  <dialog id="bulkModal">
    <form method="dialog">
      <div class="modal-header">
        <strong>Bulk add keys</strong>
        <button type="button" onclick="closeDialog('bulkModal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>Product</label>
          <select id="bulkProduct">
            <option value="Shadow">Shadow</option>
            <option value="Black">Black</option>
            <option value="Nebula">Nebula</option>
            <option value="Fatality">Fatality</option>
          </select>
        </div>
        <div class="field">
          <label>Type</label>
          <select id="bulkType"><option value="Day">Day</option><option value="Week">Week</option><option value="Month">Month</option><option value="Lifetime">Lifetime</option></select>
        </div>
        <div class="field">
          <label>Paste keys (one per line)</label>
          <textarea id="bulkText" placeholder="KEY-ABC-123&#10;KEY-DEF-456&#10;…"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeDialog('bulkModal')">Cancel</button>
        <button type="button" class="btn-primary" onclick="saveBulkAdd()">Add</button>
      </div>
    </form>
  </dialog>

  <!-- Single Add Modal -->
  <dialog id="singleModal">
    <form method="dialog">
      <div class="modal-header">
        <strong>New key</strong>
        <button type="button" onclick="closeDialog('singleModal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="field"><label>Product</label>
          <select id="s_product"><option>Shadow</option><option>Black</option><option>Nebula</option><option>Fatality</option></select>
        <div class="field"><label>Type</label>
          <select id="s_type"><option>Day</option><option>Week</option><option>Month</option><option>Lifetime</option></select></div>
        <div class="field"><label>Key code</label>
          <input id="s_code" type="text" placeholder="Paste the actual code" required></div>
      </div>
      <div class="modal-footer">
        <button type="button" onclick="closeDialog('singleModal')">Cancel</button>
        <button type="button" class="btn-primary" onclick="saveSingleAdd()">Add</button>
      </div>
    </form>
  </dialog>

  <script>
    /* ---------- tiny helpers ---------- */
    function $(q, el){ return (el||document).querySelector(q); }
    function openDialog(id){ try{ document.getElementById(id).showModal(); }catch{ document.getElementById(id).setAttribute('open',''); } }
    function closeDialog(id){ try{ document.getElementById(id).close(); }catch{ document.getElementById(id).removeAttribute('open'); } }

    /* ---------- Banner & Toast ---------- */
    function showBanner(msg){
      var host=document.getElementById('banner'); if(!host) return;
      host.innerHTML='<div class="msg">'+String(msg||'')+'<button class="close" aria-label="Dismiss" title="Dismiss">×</button></div>';
      host.classList.add('show');
      clearTimeout(showBanner.__t);
      showBanner.__t=setTimeout(function(){ hideBanner(); }, 4200);
      var btn=host.querySelector('button.close'); if(btn){ btn.onclick=function(){ hideBanner(true); }; }
    }
    function hideBanner(immediate){
      var host=document.getElementById('banner'); if(!host) return;
      if(immediate){ clearTimeout(showBanner.__t); }
      host.classList.remove('show');
    }
    function showToast(msg){
      var host=document.getElementById('toast'); if(!host) return;
      host.innerHTML = '<div class="msg">'+String(msg||'')+'</div>';
      host.style.display = 'block';
      var m = host.querySelector('.msg');
      if(m){ m.style.animation = 'none'; void m.offsetWidth; m.style.animation = 'toast-pop 1.8s ease forwards'; }
      clearTimeout(showToast.__t); showToast.__t = setTimeout(function(){ host.style.display = 'none'; }, 1800);
    }
    window.alert=function(m){showBanner(m);};

    /* ---------- Per-user accents ---------- */
    const USER_ACCENTS={ 'JXHNWACK':['#69CFDA','#41A8B5'], 'UncleJoey':['#69CFDA','#41A8B5'], 'UncleG':['#69CFDA','#41A8B5'], 'UncleTrash':['#69CFDA','#41A8B5'] };
    function applyUserAccent(user){
      var pair=USER_ACCENTS[user];
      if(!pair) return;
      document.documentElement.style.setProperty('--accent',pair[0]);
      document.documentElement.style.setProperty('--accent-2',pair[1]);
    }

    /* ======== SteinHQ v2 Cloud (resilient) ======== */
    const STEIN_BASE    = 'https://api.steinhq.com/v1/storages/68e8001faffba40a6208a923';
    const STEIN_SHEET   = 'STEIN_SHEET';         // <— your tab name
    const STEIN_TOKEN   = '';             // add X-Auth-Token if private
    const CLOUD_ENABLED = true;

    function steinHeaders(){
      const h = { 'Accept':'application/json', 'Content-Type':'application/json' };
      if (STEIN_TOKEN) h['X-Auth-Token'] = STEIN_TOKEN;
      return h;
    }

    async function backoff(fn, tries=3){
      let attempt=0, lastErr;
      while(attempt<tries){
        try{ return await fn(); }
        catch(e){ lastErr=e; await new Promise(r=>setTimeout(r, 400*Math.pow(2,attempt))); attempt++; }
      }
      throw lastErr;
    }

    async function ensureSheet(){
      const url = `${STEIN_BASE}/${encodeURIComponent(STEIN_SHEET)}`;
      try{ await fetch(url, { method:'POST', headers: steinHeaders(), body: JSON.stringify([]) }); }catch(e){}
    }

    function coerceRow(r){
      return {
        id:         r.id         || (Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(2)),
        code:       r.code       || '',
        product:    r.product    || '',
        type:       r.type       || 'Day',
        status:     r.status     || 'available',
        assignedTo: r.assignedTo || '',
        reason:     r.reason     || '',
        date:       r.date       || '',
        assignedBy: r.assignedBy || ''
      };
    }

    async function cloudGetAll(){
      const url = `${STEIN_BASE}/${encodeURIComponent(STEIN_SHEET)}`;
      const exec = async () => {
        const r = await fetch(url, { method:'GET', headers: steinHeaders(), cache:'no-store' });
        if(!r.ok){
          const msg = await r.text().catch(()=>r.statusText);
          if (r.status === 404){ await ensureSheet(); throw new Error('Sheet missing (bootstrap attempted). Reload and try again.'); }
          throw new Error(`Cloud fetch failed: ${msg}`);
        }
        return await r.json();
      };
      const rows = await backoff(exec);
      setCloudStatus(true);
      return rows;
    }

    async function cloudAppend(rows){
      if(!rows || !rows.length) return;
      const url = `${STEIN_BASE}/${encodeURIComponent(STEIN_SHEET)}`;
      const exec = async () => {
        const r = await fetch(url, { method:'POST', headers: steinHeaders(), body: JSON.stringify(rows) });
        if(!r.ok){
          const msg = await r.text().catch(()=>r.statusText);
          if (r.status === 404){ await ensureSheet(); throw new Error('Sheet missing (bootstrap attempted). Try again.'); }
          throw new Error(`Cloud append failed: ${msg}`);
        }
      };
      await backoff(exec);
      setCloudStatus(true);
    }

    async function cloudPatchById(id, patch){
      const url = `${STEIN_BASE}/${encodeURIComponent(STEIN_SHEET)}`;
      const body = { condition:{ id }, set: patch };
      const exec = async () => {
        const r = await fetch(url, { method:'PUT', headers: steinHeaders(), body: JSON.stringify(body) });
        if(!r.ok){ const msg = await r.text().catch(()=>r.statusText); throw new Error(`Cloud patch failed: ${msg}`); }
      };
      await backoff(exec);
      setCloudStatus(true);
    }

    async function cloudDeleteById(id){
      const url = `${STEIN_BASE}/${encodeURIComponent(STEIN_SHEET)}`;
      const body = { condition:{ id } };
      const exec = async () => {
        const r = await fetch(url, { method:'DELETE', headers: steinHeaders(), body: JSON.stringify(body) });
        if(!r.ok){ const msg = await r.text().catch(()=>r.statusText); throw new Error(`Cloud delete failed: ${msg}`); }
      };
      await backoff(exec);
      setCloudStatus(true);
    }

    /* ---------- Cloud/Net status UI ---------- */
    let LAST_SYNC_AT = null;
    let SYNC_TOASTED = false;

    function setCloudStatus(ok, msg){
      var chip = document.getElementById('cloudChip'); if(!chip) return;
      var dot   = chip.querySelector('.dot');
      var label = document.getElementById('cloudLabel');

      if(dot){ dot.classList.remove('ok','danger'); dot.classList.add(ok ? 'ok' : 'danger'); }

      if(ok){
        LAST_SYNC_AT = new Date();
        if(label){ label.textContent = 'Cloud • ' + LAST_SYNC_AT.toLocaleTimeString(); }
        chip.title = 'Cloud: OK — Last sync at ' + LAST_SYNC_AT.toLocaleString();
        if(!SYNC_TOASTED){ showToast('Sync successful ✔'); SYNC_TOASTED = true; }
        setNetStatus(true);
      }else{
        if(label) label.textContent = 'Cloud Error';
        chip.title = 'Cloud: Error — ' + (msg || 'Unknown');
        SYNC_TOASTED = false;
      }
    }

    function setNetStatus(on){
      var chip = document.getElementById('netChip'); if(!chip) return;
      var dot = chip.querySelector('.dot');
      if(dot){ dot.classList.remove('ok','danger'); dot.classList.add(on ? 'ok' : 'danger'); }
      var t = document.getElementById('netText'); if(t) t.textContent = on ? 'Online' : 'Offline';
    }
    window.addEventListener('online',  function(){ setNetStatus(true);  });
    window.addEventListener('offline', function(){ setNetStatus(false); });

    /* ---------- Login (robust) ---------- */
    const USERS = { 'JXHNWACK':'1212', 'UncleJoey':'password', 'UncleG':'password', 'UncleTrash':'password' };

    function pickPresetUser(name){
      if(!name) return;
      var pEl = document.getElementById('loginPass'); if(pEl) pEl.focus();
      toggleLoginButton();
    }

    var __rotTimer = null;
    var __rotMsgs = [ 'Welcome to Fatal Services','Securely manage your keys','Staff access only' ];
    var __rotIdx = 0;
    function startLoginRotator(){
      var el = document.getElementById('loginRotator'); if(!el) return;
      el.textContent = __rotMsgs[__rotIdx % __rotMsgs.length];
      clearInterval(__rotTimer);
      __rotTimer = setInterval(function(){
        __rotIdx++; el.textContent = __rotMsgs[__rotIdx % __rotMsgs.length];
        el.style.animation = 'none'; void el.offsetWidth; el.style.animation = '';
      }, 3000);
    }
    function stopLoginRotator(){ if(__rotTimer){ clearInterval(__rotTimer); __rotTimer = null; } }

    function attemptLogin(ev){
      if(ev) ev.preventDefault();
      const uPick = (document.getElementById('loginPick')?.value || '').trim();
      const p = (document.getElementById('loginPass')?.value || '');

      // dev bypass: ?dev=1&as=JXHNWACK
      const qs = new URLSearchParams(location.search);
      const dev = qs.get('dev') === '1';
      const as  = (qs.get('as') || '').trim();
      const u = (dev && as) ? as : uPick;

      if ((USERS[u] && USERS[u] === p) || (dev && as)){
        stopLoginRotator();
        var greet = document.querySelector('#welcomeScreen .welcome-greeting');
        if(greet){ greet.textContent = 'WELCOME ' + u.toUpperCase(); greet.style.display = 'block'; setTimeout(function(){ greet.style.opacity = '1'; }, 50); }
        var el = document.getElementById('welcomeScreen');
        var logoImg = el ? el.querySelector('.welcome-card img') : null;
        var btn = document.getElementById('loginGo');
        var barWrap = document.getElementById('loginProgress');
        if(btn){ btn.disabled = true; btn.textContent = 'Signing in…'; }
        if(logoImg){ logoImg.classList.add('login-pulse'); }
        if(barWrap){
          barWrap.style.display = 'block';
          var bar = barWrap.querySelector('.bar');
          if(bar){ bar.style.animation = 'none'; bar.offsetHeight; bar.style.animation = 'progress-run 3.6s ease-in-out forwards'; }
        }
        setTimeout(function(){
          if(el) el.style.display = 'none';
          window.scrollTo(0,0); document.documentElement.scrollLeft = 0; document.body.scrollLeft = 0;
          try{ sessionStorage.setItem('fs_authed','1'); sessionStorage.setItem('fs_user', u || 'User'); }catch(e){}
          var menu=document.getElementById('userMenu'); var btnU=document.getElementById('userBtn');
          if(menu) menu.style.display='inline-block';
          if(btnU) btnU.textContent = (u || 'User') + ' ▾';
          applyUserAccent(u || 'User');
        }, 3600);
        return false;
      }else{
        var err = document.getElementById('welcomeError'); if(err) err.style.display = 'block';
        var card = document.querySelector('#welcomeScreen .welcome-card');
        if(card){ card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake'); }
        return false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loginPick')?.addEventListener('change', toggleLoginButton);
      document.getElementById('loginPass')?.addEventListener('input', toggleLoginButton);
      toggleLoginButton();

      try{
        if(sessionStorage.getItem('fs_authed') === '1'){
          var el=document.getElementById('welcomeScreen'); if(el) el.style.display='none';
          var u=sessionStorage.getItem('fs_user')||'User'; applyUserAccent(u);
          var menu=document.getElementById('userMenu'); var btn=document.getElementById('userBtn');
          if(menu) menu.style.display='inline-block'; if(btn) btn.textContent = u + ' ▾';
        }
      }catch(e){}
    });

    function toggleLoginButton(){
      var pick = document.getElementById('loginPick');
      var pass = document.getElementById('loginPass');
      var btn  = document.getElementById('loginGo');
      if(!btn) return;
      var hasUser = !!(pick && pick.value);
      var hasPass = !!(pass && pass.value && pass.value.length>0);
      btn.disabled = !(hasUser && hasPass);
    }

    function toggleUserDropdown(){
      var dd=document.getElementById('userDropdown');
      if(dd) dd.style.display = (dd.style.display==='block'?'none':'block');
    }
    function logout(){
      try{ sessionStorage.removeItem('fs_authed'); sessionStorage.removeItem('fs_user'); }catch(e){}
      location.reload();
    }

    /* ---------- local state ---------- */
    const STORAGE_KEY='fs-key-manager-v1';
    const state={ keys:[], filterProduct:'All', filterType:'All', search:'', sortKey:'', sortDir:'asc' };

    function applyTheme(){
      try{
        const pref = localStorage.getItem('fs_theme') || 'dark';
        if(pref === 'light'){ document.documentElement.classList.add('light'); }
        else{ document.documentElement.classList.remove('light'); }
      }catch(e){ document.documentElement.classList.remove('light'); }
    }
    function toggleTheme(){
      const isLight = document.documentElement.classList.contains('light');
      const next = isLight ? 'dark' : 'light';
      try{ localStorage.setItem('fs_theme', next); }catch(e){}
      applyTheme();
    }

    function sortRows(rows){
      const key = state.sortKey; if(!key) return rows;
      const dir = state.sortDir === 'desc' ? -1 : 1;
      function val(k){
        if(key==='date'){ return (k.date ? new Date(k.date).getTime() : 0); }
        if(key==='assignedTo'){ return (k.assignedTo || '').toLowerCase(); }
        if(key==='product'){ return (k.product || '').toLowerCase(); }
        return (k[key] || '').toString().toLowerCase();
      }
      return rows.slice().sort((a,b)=>{ const va = val(a), vb = val(b); if(va<vb) return -1*dir; if(va>vb) return 1*dir; return 0; });
    }
    function sortCaret(k){ if(state.sortKey!==k) return '<span class="caret">↕︎</span>'; return '<span class="caret">'+(state.sortDir==='asc'?'▲':'▼')+'</span>'; }
    function setSort(k){ if(state.sortKey===k){ state.sortDir = (state.sortDir==='asc' ? 'desc' : 'asc'); }else{ state.sortKey = k; state.sortDir = 'asc'; } render(); }

    /* ---------- Undo stack ---------- */
    const UNDO_STACK = [];
    function updateUndoUI(){ var b=document.getElementById('undoBtn'); if(b) b.disabled = UNDO_STACK.length===0; }
    function pushUndo(entry){ UNDO_STACK.push(entry); updateUndoUI(); }
    async function onUndo(){
      const last = UNDO_STACK.pop(); updateUndoUI(); if(!last) return;
      try{
        if(last.type==='add'){
          const ids = last.payload.ids || [];
          if(CLOUD_ENABLED){ for(const id of ids){ await cloudDeleteById(id); } await load(); }
          else { state.keys = state.keys.filter(k=>!ids.includes(k.id)); await save(); }
        }else if(last.type==='delete'){
          const items = last.payload.items || [];
          if(CLOUD_ENABLED){ await cloudAppend(items); await load(); }
          else { state.keys.unshift(...items); await save(); }
        }else if(last.type==='assign' || last.type==='release'){
          const prev = last.payload.prev; if(!prev) return;
          if(CLOUD_ENABLED){
            await cloudPatchById(prev.id, { code: prev.code, product: prev.product, type: prev.type, status: prev.status, assignedTo: prev.assignedTo, reason: prev.reason, date: prev.date, assignedBy: prev.assignedBy || '' });
            await load();
          }else{
            const idx = state.keys.findIndex(x=>x.id===prev.id); if(idx>-1){ state.keys[idx]=Object.assign({}, prev); } await save();
          }
        }
      }catch(e){ console.error('Undo failed', e); alert('Undo failed: '+ (e && e.message ? e.message : e)); }
    }

    function uid(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(2); }
    async function save(renderAfter=true){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} if(renderAfter) render(); }

    async function load(){
      if(CLOUD_ENABLED){
        try{
          const rows = await cloudGetAll();
          state.keys = rows.map(coerceRow);
          setCloudStatus(true);
          return render();
        }catch(err){
          setCloudStatus(false, String(err && err.message || err));
          console.warn('Cloud load failed, falling back to localStorage', err);
        }
      }
      try{
        const raw=localStorage.getItem(STORAGE_KEY);
        if(raw){ Object.assign(state, JSON.parse(raw)); }
      }catch(e){}
      render();
    }

    /* ---------- Tabs & filtering ---------- */
    function renderTabs(){
      const available = state.keys.filter(k=>k.status==='available');
      const byProd = available.reduce((a,k)=>{ a[k.product]=(a[k.product]||0)+1; return a; },{});
      const allCount = available.length;
      const assignedCount = state.keys.filter(k=>k.status==='assigned' || k.status==='expired').length;

      const tabs = ['All','Shadow','Black','Nebula','Fatality','Assigned'].map(p=>{
        let c=0, dot='ok';
        if(p==='All') c = allCount;
        else if(p==='Assigned'){ c = assignedCount; dot='warn'; }
        else c = (byProd[p]||0);
        return '<div class="tab '+(state.filterProduct===p?'active':'')+'" onclick="setFilter(\''+p+'\')">'+
                 p+' <span class="chip"><span class="dot '+dot+'"></span>'+c+'</span></div>';
      }).join('');
      $('#tabs').innerHTML = tabs;

      if(!document.getElementById('tabUnderline')){
        const ul=document.createElement('div');
        ul.id='tabUnderline'; ul.className='tab-underline';
        document.getElementById('tabs').appendChild(ul);
      }
      moveTabUnderline();
    }
    function setFilter(p){ state.filterProduct=p; render(); moveTabUnderline(); }
    function moveTabUnderline(){
      var tabsEl=document.getElementById('tabs'); var underline=document.getElementById('tabUnderline');
      if(!tabsEl || !underline) return;
      var active=tabsEl.querySelector('.tab.active');
      if(active){ underline.style.width=active.offsetWidth+'px'; underline.style.transform='translateX('+active.offsetLeft+'px)'; underline.style.opacity='1'; }
      else{ underline.style.width='0'; underline.style.opacity='0'; }
    }

    function visibleRows(){
      const inAssigned = state.filterProduct==='Assigned';
      const q=(state.search||'').toLowerCase();
      const typeWanted = state.filterType || 'All';
      return state.keys.filter(k=>{
        const assignedish=(k.status==='assigned'||k.status==='expired');
        const statusOk = inAssigned ? assignedish : (k.status==='available');
        const productOk = state.filterProduct==='All' || state.filterProduct==='Assigned' || k.product===state.filterProduct;
        const typeOk = (typeWanted==='All') ? true : (k.type===typeWanted);
        const hay=[k.code,k.product,k.type,k.status,k.assignedTo||'',k.reason||'',k.date||''].join(' ').toLowerCase();
        return statusOk && productOk && typeOk && (!q || hay.indexOf(q)!==-1);
      });
    }

    /* ---------- Actions ---------- */
    function copyCode(id){
      const k=state.keys.find(x=>x.id===id);
      if(k && navigator.clipboard){ navigator.clipboard.writeText(k.code).then(function(){ showToast('Copied ✔'); }); }
    }

    async function removeKey(id){
      if(!confirm('Delete this key from your list?')) return;
      const k=state.keys.find(x=>x.id===id); if(!k) return;
      pushUndo({ type:'delete', payload:{ items:[ Object.assign({}, k) ] } });
      if(CLOUD_ENABLED){ await cloudDeleteById(k.id); await load(); return; }
      state.keys=state.keys.filter(x=>x.id!==id); save();
    }

    async function releaseKey(id){
      const k=state.keys.find(x=>x.id===id); if(!k) return;
      const prev = Object.assign({}, k); pushUndo({ type:'release', payload:{ prev } });
      const patch = { status:'available', assignedTo:'', reason:'', date:'', assignedBy:'' };
      if(CLOUD_ENABLED){ await cloudPatchById(k.id, patch); showToast('Released ✔'); await load(); return; }
      Object.assign(k, patch); showToast('Released ✔'); save();
    }

    let assignId=null;
    function openAssign(id){
      const k=state.keys.find(x=>x.id===id); if(!k) return;
      assignId=id;
      $('#m_code').value=k.code; $('#m_product').value=k.product;
      $('#m_user').value=k.assignedTo||''; $('#m_reason').value=k.reason||'';
      $('#m_date').value=k.date||new Date().toISOString().slice(0,10);
      openDialog('assignModal');
    }
    async function saveAssign(){
      const k=state.keys.find(x=>x.id===assignId); if(!k) return;
      const prev = Object.assign({}, k); pushUndo({ type:'assign', payload:{ prev } });
      const patch = {
        assignedTo: $('#m_user').value.trim(),
        reason: $('#m_reason').value.trim(),
        date: $('#m_date').value,
        status: 'assigned',
        assignedBy: (sessionStorage && sessionStorage.getItem('fs_user')) || 'unknown'
      };
      if(CLOUD_ENABLED){ await cloudPatchById(k.id, patch); closeDialog('assignModal'); showToast('Saved ✔'); await load(); return; }
      Object.assign(k, patch); closeDialog('assignModal'); showToast('Saved ✔'); save();
    }

    /* ---------- CSV / backup / restore ---------- */
    function csvEscape(v){ v=String(v); if(v.includes('"')) v=v.replace(/"/g,'""'); if(v.includes(',')||v.includes('\n')||v.includes('"')) v='"'+v+'"'; return v; }
    function toCSV(rows){
      const headers=['code','product','type','status','assignedTo','reason','date','assignedBy'];
      const out=[headers.join(',')];
      for(const k of rows){ out.push(headers.map(h=>csvEscape(k[h]||'')).join(',')); }
      return out.join('\n');
    }
    function onExportCSV(){
      const blob=new Blob([toCSV(state.keys)],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='fatal_keys_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
    }
    function onBackupJSON(){
      const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='fatal_keys_backup.json'; a.click();
    }
    function onRestoreJSON(file){
      if(!file) return;
      const r=new FileReader();
      r.onload=()=>{
        try{
          const incoming=JSON.parse(r.result);
          if(Array.isArray(incoming.keys)){
            state.keys=incoming.keys; state.filterProduct=incoming.filterProduct||'All'; state.search=''; save();
          }else{ alert('Invalid backup file.'); }
        }catch(e){ alert('Could not read JSON backup.'); }
      };
      r.readAsText(file);
    }

    async function onImportJSON(file){
      if(!file) return;
      const r = new FileReader();
      r.onload = async () => {
        try{
          const raw = JSON.parse(r.result);
          const rowsIn = Array.isArray(raw) ? raw : (raw && Array.isArray(raw.keys) ? raw.keys : null);
          if(!rowsIn){ alert('Invalid JSON format. Expecting an array of rows or an object with a "keys" array.'); return; }

          await load();
          const existing = new Set((state.keys||[]).map(k => String(k.code||'').toLowerCase()));
          const currentUser = (sessionStorage && sessionStorage.getItem('fs_user')) || '';
          const toPost = []; const skipped = [];

          for(const r of rowsIn){
            const code = String(r.code||'').trim(); if(!code) continue;
            const key = code.toLowerCase();
            if(existing.has(key)){ skipped.push(code); continue; }

            const row = {
              id: r.id || uid(), code, product: r.product || 'Shadow', type: r.type || 'Day',
              status: r.status || 'available', assignedTo: r.assignedTo || '', reason: r.reason || '',
              date: r.date || '', assignedBy: r.assignedBy || currentUser
            };
            toPost.push(row); existing.add(key);
          }

          if(toPost.length===0){ alert(skipped.length ? 'All rows were duplicates—nothing imported.' : 'Nothing to import.'); return; }

          if(CLOUD_ENABLED){ await cloudAppend(toPost); await load(); }
          else { state.keys.unshift(...toPost); await save(); }

          let msg = 'Imported '+toPost.length+' row(s).';
          if(skipped.length){ msg += '\nSkipped duplicates: '+skipped.length; }
          alert(msg);
        }catch(e){ console.error('Import failed', e); alert('Import failed: '+(e && e.message ? e.message : e)); }
      };
      r.readAsText(file);
    }

    /* ---------- Render ---------- */
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

    function renderTable(){
      const rows=visibleRows(); const sorted = sortRows(rows);
      if(!rows.length){ $('#tableWrap').innerHTML='<div class="empty">No keys yet. Use <strong>Bulk Add</strong> to paste your list, or <strong>New Single</strong> to add one.</div>'; return; }
      const query = (state.search || '').trim();
      function highlight(text){
        if(!query) return escapeHtml(String(text||''));
        const re = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')', 'ig');
        return escapeHtml(String(text||'')).replace(re, '<mark class="hl">$1</mark>');
      }
      function pclass(p){
        if(!p) return 'pbadge';
        const slug = String(p).toLowerCase();
        return 'pbadge p-' + slug.replace(/[^a-z0-9]+/g,'');
      }
      const head = '<thead><tr>'
        + '<th>Key</th>'
        + '<th class="sortable" onclick="setSort(\'product\')">Product'+sortCaret('product')+'</th>'
        + '<th>Type</th>'
        + '<th>Status</th>'
        + '<th class="sortable" onclick="setSort(\'assignedTo\')">Discord User'+sortCaret('assignedTo')+'</th>'
        + '<th>Reason</th>'
        + '<th class="sortable" onclick="setSort(\'date\')">Date'+sortCaret('date')+'</th>'
        + '<th>Actions</th>'
        + '</tr></thead>';
      const body=sorted.map(k=>{
        const assignedish=(k.status==='assigned'||k.status==='expired');
        const chip=assignedish
          ? '<span class="chip" title="Assigned by '+escapeHtml(k.assignedBy||'unknown')+'"><span class="dot warn"></span>Assigned</span>'
          : '<span class="chip"><span class="dot ok"></span>Available</span>';
        return '<tr>'
          + '<td class="key-cell" onclick="copyCode(\''+k.id+'\')" title="Click to copy">'+highlight(k.code)+'</td>'
          + '<td><span class="'+pclass(k.product)+'">'+highlight(k.product)+'</span></td>'
          + '<td><span class="badge '+escapeHtml(k.type)+'">'+escapeHtml(k.type)+'</span></td>'
          + '<td>'+chip+'</td>'
          + '<td>'+highlight(k.assignedTo||'')+'</td>'
          + '<td>'+highlight(k.reason||'')+'</td>'
          + '<td>'+(k.date||'')+'</td>'
          + '<td class="actions">'
            + '<button type="button" onclick="copyCode(\''+k.id+'\')">Copy</button>'
            + (assignedish
              ? '<button type="button" onclick="openAssign(\''+k.id+'\')">Edit</button><button type="button" onclick="releaseKey(\''+k.id+'\')">Release</button>'
              : '<button type="button" class="btn-primary" onclick="openAssign(\''+k.id+'\')">Assign</button>')
            + '<button type="button" onclick="removeKey(\''+k.id+'\')" style="border-color: rgba(239,71,111,.5);">Delete</button>'
          + '</td></tr>';
      }).join('');
      $('#tableWrap').innerHTML='<table>'+head+'<tbody>'+body+'</tbody></table>';
    }

    function renderStats(){
      const keys = state.keys || [];
      const total = keys.length;
      const assigned = keys.filter(k => k.status==='assigned' || k.status==='expired').length;
      const available = keys.filter(k => k.status==='available').length;

      const byProd = keys.reduce((a,k)=>{ const p=k.product||'Unknown'; a[p]=(a[p]||0)+1; return a; }, {});
      const top = Object.entries(byProd).sort((a,b)=>b[1]-a[1]).slice(0,2);

      const host = document.getElementById('statsBar'); if(!host) return;
      host.innerHTML = [
        '<div class="stat-card"><div class="stat-title">Total Keys</div><div class="stat-value">'+total+'</div><div class="stat-sub">All products</div></div>',
        '<div class="stat-card"><div class="stat-title">Available</div><div class="stat-value">'+available+'</div><div class="stat-sub">Ready to assign</div></div>',
        '<div class="stat-card"><div class="stat-title">Assigned</div><div class="stat-value">'+assigned+'</div><div class="stat-sub">In use</div></div>',
        '<div class="stat-card"><div class="stat-title">Top Products</div><div class="stat-value">'+(top[0]? top[0][0]+': '+top[0][1] : '—')+'</div><div class="stat-sub">'+(top[1]? top[1][0]+': '+top[1][1] : '&nbsp;')+'</div></div>'
      ].join('');
    }

    function render(){
      renderTabs(); renderTable(); renderStats();
      var inp = document.getElementById('search'); if(inp && inp.value !== state.search){ inp.value = state.search; }
      var tf = document.getElementById('typeFilter'); if(tf && tf.value !== state.filterType){ tf.value = state.filterType; }
    }

    /* ---------- Toolbar handlers ---------- */
    function onSearchInput(val){ state.search = (val || ''); render(); }
    function onClearSearch(){ state.search=''; const i=document.getElementById('search'); if(i) i.value=''; render(); }
    function onTypeFilter(val){ state.filterType = val || 'All'; render(); }

    async function onRefreshCloud(){
      if (CLOUD_ENABLED){
        try{ SYNC_TOASTED = false; await load(); }
        catch(e){ alert('Refresh failed: ' + (e && e.message ? e.message : e)); }
      }else{ alert('Cloud sync is disabled. Set CLOUD_ENABLED = true to use Refresh.'); }
    }
    function onClearLocalCache(){ try{ localStorage.removeItem(STORAGE_KEY); alert('Local cache cleared. The page will reload.'); }catch(e){} location.reload(); }
    function onBulkAdd(){ $('#bulkProduct').value=(state.filterProduct==='All'||state.filterProduct==='Assigned')?'Shadow':state.filterProduct; $('#bulkType').value='Day'; $('#bulkText').value=''; openDialog('bulkModal'); }
    function onNewSingle(){ $('#s_product').value=(state.filterProduct==='All'||state.filterProduct==='Assigned')?'Shadow':state.filterProduct; $('#s_type').value='Day'; $('#s_code').value=''; openDialog('singleModal'); }

    async function saveBulkAdd(){
      const product=$('#bulkProduct').value;
      const type=$('#bulkType').value;
      const allExisting = new Set(state.keys.map(k=>String(k.code||'').toLowerCase()));
      const inputCodes = ($('#bulkText').value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

      const newCodes = []; const skipped = [];
      for(const c of inputCodes){
        const key = c.toLowerCase();
        if(allExisting.has(key)){ skipped.push(c); } else { newCodes.push(c); allExisting.add(key); }
      }
      if(skipped.length){ alert('Skipped duplicates:\n' + skipped.join('\n')); }
      if(newCodes.length===0){ closeDialog('bulkModal'); return; }

      if(CLOUD_ENABLED){
        const nowUser = (sessionStorage && sessionStorage.getItem('fs_user')) || '';
        const rows = newCodes.map(code => ({ id: uid(), code, product, type, status:'available', assignedTo:'', reason:'', date:'', assignedBy: nowUser }));
        await cloudAppend(rows);
        pushUndo({ type:'add', payload:{ ids: rows.map(r=>r.id) } });
        closeDialog('bulkModal'); showToast('Added ✔'); await load(); return;
      }

      const newItems=newCodes.map(code=>({id:uid(), code, product, type, status:'available', assignedTo:'', reason:'', date:'', assignedBy:''}));
      state.keys.unshift(...newItems);
      pushUndo({ type:'add', payload:{ ids: newItems.map(r=>r.id) } });
      closeDialog('bulkModal'); showToast('Added ✔'); save();
    }

    async function saveSingleAdd(){
      const code=($('#s_code').value||'').trim(); if(!code) return;
      const product=$('#s_product').value; const type=$('#s_type').value;
      const exists = state.keys.some(k => String(k.code||'').toLowerCase() === code.toLowerCase());
      if(exists){ alert('That code already exists and was not added.'); return; }

      if(CLOUD_ENABLED){
        const nowUser = (sessionStorage && sessionStorage.getItem('fs_user')) || '';
        const id = uid();
        await cloudAppend([{ id, code, product, type, status:'available', assignedTo:'', reason:'', date:'', assignedBy: nowUser }]);
        pushUndo({ type:'add', payload:{ ids:[id] } });
        closeDialog('singleModal'); showToast('Added ✔'); await load(); return;
      }

      const item={id:uid(), code, product, type, status:'available', assignedTo:'', reason:'', date:'', assignedBy:''};
      state.keys.unshift(item);
      pushUndo({ type:'add', payload:{ ids:[item.id] } });
      closeDialog('singleModal'); showToast('Added ✔'); save();
    }

    /* ---------- Expose to inline handlers ---------- */
    window.setFilter=setFilter; window.copyCode=copyCode; window.removeKey=removeKey; window.releaseKey=releaseKey; window.openAssign=openAssign;
    window.onClearSearch=onClearSearch; window.onBulkAdd=onBulkAdd; window.onNewSingle=onNewSingle; window.onExportCSV=onExportCSV; window.onBackupJSON=onBackupJSON; window.onImportJSON=onImportJSON;
    window.saveAssign=saveAssign; window.saveBulkAdd=saveBulkAdd; window.saveSingleAdd=saveSingleAdd;
    window.toggleUserDropdown=toggleUserDropdown; window.logout=logout;
    window.attemptLogin=attemptLogin; window.pickPresetUser=pickPresetUser;
    window.onRefreshCloud=onRefreshCloud; window.onClearLocalCache=onClearLocalCache;
    window.onUndo=onUndo; window.toggleManageMenu=toggleManageMenu; window.setSort=setSort;

    function toggleManageMenu(){
      var m = document.getElementById('manageMenu'); if(!m) return;
      var isOpen = m.style.display === 'block'; m.style.display = isOpen ? 'none' : 'block';
    }
    document.addEventListener('click', function(e){
      var wrap = document.querySelector('.menu-wrap'); var menu = document.getElementById('manageMenu');
      if(!wrap || !menu) return; if(!wrap.contains(e.target)){ if(menu.style.display==='block') menu.style.display='none'; }
    });

    document.addEventListener('keydown', function(e){
      if((e.metaKey || e.ctrlKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); onUndo(); }
      if((e.metaKey || e.ctrlKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); const s=document.getElementById('search'); if(s){ s.focus(); s.select(); } }
    });

    /* ---------- init ---------- */
    (function(){
      applyTheme();
      startLoginRotator();
      setNetStatus(navigator.onLine);
      load();
      if(!Array.isArray(state.keys)) state.keys=[];
      render();
      window.scrollTo(0,0); document.documentElement.scrollLeft = 0; document.body.scrollLeft = 0;
    })();
  </script>

  <button id="backTop" onclick="scrollTopSmooth()" aria-label="Back to top" style="position:fixed;right:16px;bottom:16px;display:none;">↑ Top</button>
  <script>
    function scrollTopSmooth(){ window.scrollTo({top:0,behavior:'smooth'}); }
    (function(){ const b=document.getElementById('backTop'); window.addEventListener('scroll',()=>{ if(window.scrollY>300){ b.style.display='block'; } else { b.style.display='none'; } }); })();
  </script>
</body>
<div class="footer-note">Fatal Services Key Manager · v1.2 · Updated 23 Oct 2025</div>
</html>
